<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AlsaDuo – Tour interactive</title>
    <!-- Google Fonts for a premium feel -->
    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Inter:wght@300;400;500&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Base reset */
      *, *::before, *::after {
        box-sizing: border-box;
      }
      html, body {
        margin: 0;
        padding: 0;
        overflow-x: hidden;
        background: #f5efe6; /* soft cream background, matching the logo */
        color: #063c3c; /* dark green for text */
        font-family: 'Inter', sans-serif;
      }
      /* Loader overlay */
      #loader {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        background: #f5efe6;
        z-index: 20;
        transition: opacity 1s ease;
      }
      #loader.fade-out {
        opacity: 0;
        pointer-events: none;
      }
      .spinner {
        width: 48px;
        height: 48px;
        border: 4px solid rgba(6,60,60,0.2);
        border-top-color: #063c3c;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      .brand {
        margin-top: 1rem;
        font-family: 'Playfair Display', serif;
        font-size: 2rem;
        letter-spacing: 0.05rem;
        color: #063c3c;
      }
      #status {
        margin-top: 0.75rem;
        max-width: 520px;
        text-align: center;
        font-size: 0.95rem;
        line-height: 1.35;
        color: rgba(6, 60, 60, 0.75);
        font-family: 'Inter', sans-serif;
        padding: 0 1rem;
      }
      #status.error {
        color: #7a1f1f;
      }
      .logo {
        width: 160px;
        height: auto;
        margin-bottom: 1rem;
      }
      /* Canvas styling */
      #webgl {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        outline: none;
        z-index: 0;
      }
      /* Section overlay container */
      #sections {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        pointer-events: none;
        z-index: 10;
      }
      .section {
        position: absolute;
        width: 80%;
        max-width: 800px;
        text-align: center;
        font-family: 'Playfair Display', serif;
        font-weight: 400;
        font-size: clamp(1.5rem, 4vw, 3rem);
        line-height: 1.3;
        opacity: 0;
        transform: translateY(50px);
        transition: opacity 0.7s ease, transform 0.7s ease;
        padding: 1rem;
        color: #063c3c;
      }
      .section.active {
        opacity: 1;
        transform: translateY(0);
      }
      /* Scroll container to enable scroll-driven animation */
      #scroll-area {
        position: relative;
        width: 100%;
        height: 300vh;
        z-index: 1;
      }
      /* Responsive adjustments */
      @media (max-width: 600px) {
        .logo { width: 120px; }
        .brand { font-size: 1.5rem; }
        .section { font-size: clamp(1.2rem, 5vw, 2rem); }
      }
    </style>
  </head>
  <body>
    <!-- Loader with brand elements -->
    <div id="loader">
      <img class="logo" src="logoalsaduo.png" alt="AlsaDuo" />
      <div class="spinner"></div>
      <div class="brand">AlsaDuo</div>
      <div id="status">Chargement du modèle 3D…</div>
    </div>
    <!-- Three.js canvas -->
    <canvas id="webgl"></canvas>
    <!-- Overlaid text sections -->
    <div id="sections">
      <div id="section1" class="section">
        Découvrez notre minaret emblématique, symbole de tradition et d'élégance.
      </div>
      <div id="section2" class="section">
        Explorez les saveurs et les histoires d'Alsace à travers AlsaDuo.
      </div>
      <div id="section3" class="section">
        Rejoignez-nous pour une expérience unique mêlant culture et gourmandise.
      </div>
    </div>
    <!-- Scroll area to capture scroll progress -->
    <div id="scroll-area"></div>
    <!-- Three.js (ESM) with multi-CDN fallback + robust error handling -->
    <script type="module">
      const canvas = document.getElementById('webgl');
      const loaderOverlay = document.getElementById('loader');
      const statusEl = document.getElementById('status');

      function setStatus(msg, isError = false) {
        if (!statusEl) return;
        statusEl.textContent = msg;
        statusEl.classList.toggle('error', !!isError);
      }

      // Helper for smooth interpolation
      function lerp(a, b, t) {
        return a + (b - a) * t;
      }

      // Sections (scroll-driven)
      const sections = [
        document.getElementById('section1'),
        document.getElementById('section2'),
        document.getElementById('section3'),
      ];

      // Scroll progress (0..1)
      let scrollProgress = 0;

      // Parallax values
      let targetX = 0,
        targetY = 0;
      let currentX = 0,
        currentY = 0;

      async function importThree() {
        // Use pairs so GLTFLoader and THREE resolve from the same CDN/version.
        const pairs = [
          {
            three: 'https://unpkg.com/three@0.160.0/build/three.module.js',
            loader: 'https://unpkg.com/three@0.160.0/examples/jsm/loaders/GLTFLoader.js',
          },
          {
            three: 'https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js',
            loader: 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/loaders/GLTFLoader.js',
          },
          {
            three: 'https://esm.sh/three@0.160.0',
            loader: 'https://esm.sh/three@0.160.0/examples/jsm/loaders/GLTFLoader.js',
          },
        ];
        let lastErr;
        for (const p of pairs) {
          try {
            const THREE = await import(p.three);
            const mod = await import(p.loader);
            const GLTFLoader = mod.GLTFLoader;
            if (!GLTFLoader) throw new Error('GLTFLoader introuvable sur ce CDN');
            return { THREE, GLTFLoader };
          } catch (e) {
            lastErr = e;
          }
        }
        throw lastErr || new Error('Impossible de charger Three.js');
      }

      function updateScroll() {
        const scrollTop = window.scrollY;
        const docHeight = document.body.scrollHeight - window.innerHeight;
        scrollProgress = docHeight > 0 ? scrollTop / docHeight : 0;
        updateSections(scrollProgress);
      }

      function updateSections(progress) {
        const num = sections.length;
        sections.forEach((sec, idx) => {
          if (!sec) return;
          const start = idx / num;
          const end = (idx + 1) / num;
          const local = (progress - start) / (end - start);
          if (local >= 0 && local <= 1) sec.classList.add('active');
          else sec.classList.remove('active');
        });
      }

      function hideLoader() {
        loaderOverlay.classList.add('fade-out');
        setTimeout(() => {
          loaderOverlay.style.display = 'none';
        }, 1000);
      }

      (async () => {
        try {
          setStatus('Chargement du moteur 3D…');
          const { THREE, GLTFLoader } = await importThree();

          setStatus('Initialisation de la scène…');
          const scene = new THREE.Scene();

          const camera = new THREE.PerspectiveCamera(
            45,
            window.innerWidth / window.innerHeight,
            0.1,
            100
          );
          camera.position.set(0, 1.5, 4);

          const renderer = new THREE.WebGLRenderer({
            canvas,
            antialias: true,
            alpha: true,
            powerPreference: 'high-performance',
          });
          renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));
          renderer.setSize(window.innerWidth, window.innerHeight);

          const hemi = new THREE.HemisphereLight(0xffffff, 0xcccccc, 1.0);
          hemi.position.set(0, 1, 0);
          scene.add(hemi);
          const dir = new THREE.DirectionalLight(0xffffff, 0.85);
          dir.position.set(5, 10, 7.5);
          scene.add(dir);

          setStatus('Chargement du modèle 3D…');
          const gltfLoader = new GLTFLoader();

          // Try multiple filenames (your repo might keep the original name).
          const candidates = [
            'minaret_model.glb',
            'minaret%203d%20model-2.glb',
            'minaret 3d model-2.glb',
          ];
          let gltf = null;
          let usedUrl = null;
          for (const url of candidates) {
            try {
              gltf = await gltfLoader.loadAsync(url);
              usedUrl = url;
              break;
            } catch (e) {
              // keep trying
            }
          }
          if (!gltf) {
            throw new Error(
              "Modèle introuvable. Mets le fichier .glb au même niveau que index.html (nom conseillé: minaret_model.glb)."
            );
          }

          const model = gltf.scene;
          model.traverse((child) => {
            if (child && child.isMesh) {
              child.castShadow = true;
              child.receiveShadow = true;
            }
          });

          // Compute bounding box to scale and center the model
          const box = new THREE.Box3().setFromObject(model);
          const size = new THREE.Vector3();
          box.getSize(size);
          const maxDim = Math.max(size.x, size.y, size.z) || 1;
          const scale = 2.5 / maxDim;
          model.scale.setScalar(scale);

          // Center the model
          box.setFromObject(model);
          const center = new THREE.Vector3();
          box.getCenter(center);
          model.position.x -= center.x;
          model.position.y -= (center.y - size.y * scale * 0.5);
          model.position.z -= center.z;
          scene.add(model);

          setStatus(`Prêt ✅ (${usedUrl})`);
          hideLoader();

          // Events
          function onResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
          }
          window.addEventListener('resize', onResize);

          window.addEventListener('pointermove', (event) => {
            const x = (event.clientX / window.innerWidth) * 2 - 1;
            const y = (event.clientY / window.innerHeight) * 2 - 1;
            targetX = x;
            targetY = y;
          });
          window.addEventListener('scroll', updateScroll);
          updateScroll();

          // Animation loop
          function animate() {
            requestAnimationFrame(animate);

            currentX = lerp(currentX, targetX, 0.05);
            currentY = lerp(currentY, targetY, 0.05);

            camera.position.x = currentX * 0.6;
            camera.position.y = 1.5 + currentY * 0.5 - scrollProgress * 2.0;
            camera.lookAt(0, 0.5 - scrollProgress * 1.5, 0);

            model.rotation.y = Math.PI * 2 * scrollProgress;

            renderer.render(scene, camera);
          }
          animate();
        } catch (err) {
          console.error(err);
          setStatus(
            "Erreur: impossible d'afficher la 3D. Ouvre la console (F12) pour voir le détail. Vérifie aussi que le .glb est bien présent à côté de index.html.",
            true
          );
        }
      })();
    </script>
  </body>
</html>